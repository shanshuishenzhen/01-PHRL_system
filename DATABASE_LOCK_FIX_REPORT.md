# æ•°æ®åº“é”å®šé—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ¯ é—®é¢˜æè¿°

åœ¨ä¿®å¤ä¸Šä¼ ç»„é¢˜è§„åˆ™åŠŸèƒ½åï¼Œå‡ºç°äº†æ–°çš„æ•°æ®åº“é”å®šé”™è¯¯ï¼š

```
database is locked [SQL: INSERT INTO papers (id, name, description, total_score, duration, difficulty_level, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)]
```

è¿™æ˜¯SQLiteæ•°æ®åº“çš„å¹¶å‘è®¿é—®é”å®šé—®é¢˜ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### 1. æ ¹æœ¬åŸå› 
- **å¤šè¿›ç¨‹è®¿é—®**ï¼šåŒæ—¶è¿è¡Œå¤šä¸ªPythonè¿›ç¨‹è®¿é—®åŒä¸€ä¸ªSQLiteæ•°æ®åº“
- **é•¿æ—¶é—´äº‹åŠ¡**ï¼šæŸäº›æ“ä½œæŒæœ‰æ•°æ®åº“è¿æ¥æ—¶é—´è¿‡é•¿
- **æœªæ­£ç¡®å…³é—­è¿æ¥**ï¼šéƒ¨åˆ†æ•°æ®åº“è¿æ¥æœªæ­£ç¡®é‡Šæ”¾

### 2. å‘ç°çš„é—®é¢˜è¿›ç¨‹
é€šè¿‡è¿›ç¨‹æ£€æŸ¥å‘ç°ä»¥ä¸‹è¿›ç¨‹æ­£åœ¨ä½¿ç”¨æ•°æ®åº“ï¼š
- PID: 5728 - `python.exe run.py --silent`
- PID: 8768 - `python.exe app.py`  
- PID: 20468 - `python.exe app.py`

### 3. é”å®šæ–‡ä»¶
SQLiteåˆ›å»ºçš„ä¸´æ—¶é”å®šæ–‡ä»¶ï¼š
- `questions.db-shm` (å…±äº«å†…å­˜æ–‡ä»¶)
- `questions.db-wal` (é¢„å†™æ—¥å¿—æ–‡ä»¶)
- `questions.db-journal` (å›æ»šæ—¥å¿—æ–‡ä»¶)

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. åˆ›å»ºæ•°æ®åº“é”å®šä¿®å¤å·¥å…·

**æ–‡ä»¶**: `fix_database_lock.py`

ä¸»è¦åŠŸèƒ½ï¼š
- æ£€æŸ¥æ•°æ®åº“é”å®šçŠ¶æ€
- æŸ¥æ‰¾ä½¿ç”¨æ•°æ®åº“çš„è¿›ç¨‹
- ç»ˆæ­¢å†²çªè¿›ç¨‹
- æ¸…ç†é”å®šæ–‡ä»¶
- è®¾ç½®WALæ¨¡å¼ä¼˜åŒ–
- æµ‹è¯•æ•°æ®åº“æ“ä½œ

### 2. è¿›ç¨‹ç®¡ç†
```python
# ç»ˆæ­¢å†²çªçš„Pythonè¿›ç¨‹
for proc in processes:
    if 'python' in proc['name'].lower():
        p.terminate()  # ä¼˜é›…ç»ˆæ­¢
        if p.is_running():
            p.kill()   # å¼ºåˆ¶ç»ˆæ­¢
```

### 3. æ•°æ®åº“ä¼˜åŒ–é…ç½®
```python
# è®¾ç½®WALæ¨¡å¼å’Œä¼˜åŒ–å‚æ•°
conn.execute("PRAGMA journal_mode=WAL;")      # é¢„å†™æ—¥å¿—æ¨¡å¼
conn.execute("PRAGMA synchronous=NORMAL;")    # åŒæ­¥æ¨¡å¼
conn.execute("PRAGMA cache_size=10000;")      # ç¼“å­˜å¤§å°
conn.execute("PRAGMA temp_store=memory;")     # ä¸´æ—¶å­˜å‚¨åœ¨å†…å­˜
```

### 4. æ¸…ç†é”å®šæ–‡ä»¶
```python
# åˆ é™¤SQLiteé”å®šæ–‡ä»¶
lock_files = ['questions.db-shm', 'questions.db-wal', 'questions.db-journal']
for lock_file in lock_files:
    if os.path.exists(lock_file):
        os.remove(lock_file)
```

### 5. æ”¹è¿›äº‹åŠ¡å¤„ç†

**æ–‡ä»¶**: `paper_generator.py`

æ·»åŠ é‡è¯•æœºåˆ¶å’Œæ›´å¥½çš„é”™è¯¯å¤„ç†ï¼š
```python
# é‡è¯•æœºåˆ¶å¤„ç†æ•°æ®åº“é”å®š
max_retries = 3
for attempt in range(max_retries):
    try:
        # æ•°æ®åº“æ“ä½œ
        self.db_session.commit()
        return paper
    except OperationalError as e:
        if "database is locked" in str(e) and attempt < max_retries - 1:
            self.db_session.rollback()
            time.sleep(retry_delay * (attempt + 1))
            continue
        else:
            self.db_session.rollback()
            raise e
```

### 6. å®‰å…¨æ•°æ®åº“è¿æ¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
```python
@contextmanager
def safe_db_connection(db_path='questions.db', timeout=30.0):
    conn = None
    try:
        conn = sqlite3.connect(db_path, timeout=timeout)
        conn.execute("PRAGMA journal_mode=WAL;")
        conn.execute("PRAGMA synchronous=NORMAL;")
        yield conn
    except Exception as e:
        if conn:
            conn.rollback()
        raise e
    finally:
        if conn:
            conn.close()
```

## ğŸ“Š ä¿®å¤ç»“æœ

### ä¿®å¤è¿‡ç¨‹è¾“å‡º
```
æ•°æ®åº“é”å®šé—®é¢˜ä¿®å¤å·¥å…·
==================================================
=== æ£€æŸ¥æ•°æ®åº“é”å®šçŠ¶æ€ ===
âŒ æ•°æ®åº“è¢«é”å®š

=== å¤‡ä»½æ•°æ®åº“ ===
âœ… æ•°æ®åº“å·²å¤‡ä»½åˆ°: questions_backup_1751654121.db

=== æŸ¥æ‰¾ä½¿ç”¨æ•°æ®åº“çš„è¿›ç¨‹ ===
æ‰¾åˆ°ä»¥ä¸‹è¿›ç¨‹æ­£åœ¨ä½¿ç”¨æ•°æ®åº“:
  PID: 5728, åç§°: python.exe
  PID: 8768, åç§°: python.exe
  PID: 20468, åç§°: python.exe

=== ç»ˆæ­¢æ•°æ®åº“è¿›ç¨‹ ===
ç»ˆæ­¢Pythonè¿›ç¨‹ PID: 5728
ç»ˆæ­¢Pythonè¿›ç¨‹ PID: 8768

=== ä¿®å¤æ•°æ®åº“é”å®š ===
âœ… å·²è®¾ç½®WALæ¨¡å¼å’Œä¼˜åŒ–å‚æ•°
âœ… æ•°æ®åº“é”å®šä¿®å¤æˆåŠŸ

=== æµ‹è¯•æ•°æ®åº“æ“ä½œ ===
âœ… è¯»æ“ä½œæ­£å¸¸ï¼Œé¢˜ç›®æ•°é‡: 19662
âœ… å†™æ“ä½œæ­£å¸¸
âœ… æ•°æ®åº“åŠŸèƒ½æµ‹è¯•é€šè¿‡

ğŸ‰ æ•°æ®åº“é”å®šé—®é¢˜ä¿®å¤å®Œæˆï¼
```

### åŠŸèƒ½éªŒè¯ç»“æœ
```
å“åº”çŠ¶æ€ç : 200
âœ… ä¸Šä¼ ç»„é¢˜è§„åˆ™æµ‹è¯•æˆåŠŸ

æœ€æ–°è¯•å·: æµ‹è¯•è¯•å·_ä¿®å¤å
è¯•å·ID: 96238f38-cd60-4f76-8390-fa342dbbec2b
æ€»åˆ†: 100.0
æ—¶é•¿: 120åˆ†é’Ÿ
åˆ›å»ºæ—¶é—´: 2025-07-04 18:37:12.253895

è¯•å·é¢˜ç›®æ•°é‡: 10

é¢˜å‹ç»Ÿè®¡:
  Bå‹é¢˜: 5é“
  Gå‹é¢˜: 3é“
  Cå‹é¢˜: 2é“

âœ… ç»„å·æˆåŠŸï¼
```

## ğŸ‰ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ æ•°æ®åº“é”å®šé”™è¯¯
- âŒ æ— æ³•åˆ›å»ºè¯•å·
- âŒ å¤šè¿›ç¨‹å†²çª

### ä¿®å¤å
- âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸
- âœ… æˆåŠŸåˆ›å»ºè¯•å·
- âœ… è¿›ç¨‹ç®¡ç†ä¼˜åŒ–
- âœ… äº‹åŠ¡å¤„ç†æ”¹è¿›

## ğŸš€ é¢„é˜²æªæ–½

### 1. è¿›ç¨‹ç®¡ç†
- é¿å…åŒæ—¶è¿è¡Œå¤šä¸ªWebæœåŠ¡å™¨å®ä¾‹
- æ­£ç¡®å…³é—­ä¸éœ€è¦çš„Pythonè¿›ç¨‹
- ä½¿ç”¨è¿›ç¨‹ç›‘æ§å·¥å…·

### 2. æ•°æ®åº“è¿æ¥ç®¡ç†
- ä½¿ç”¨è¿æ¥æ± 
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- åŠæ—¶å…³é—­æ•°æ®åº“è¿æ¥

### 3. äº‹åŠ¡å¤„ç†
- ä½¿ç”¨é‡è¯•æœºåˆ¶
- åˆç†çš„äº‹åŠ¡ç²’åº¦
- å¼‚å¸¸æ—¶æ­£ç¡®å›æ»š

### 4. ç›‘æ§å’Œç»´æŠ¤
- å®šæœŸæ£€æŸ¥æ•°æ®åº“é”å®šçŠ¶æ€
- ç›‘æ§è¿›ç¨‹ä½¿ç”¨æƒ…å†µ
- å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶

## ğŸ”§ å·¥å…·ä½¿ç”¨æŒ‡å—

### 1. æ•°æ®åº“é”å®šä¿®å¤
```bash
cd question_bank_web
python fix_database_lock.py
```

### 2. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
```bash
python debug_question_count.py
```

### 3. æµ‹è¯•ç»„å·åŠŸèƒ½
```bash
python test_paper_rule.py
```

## ğŸ“ˆ ç³»ç»Ÿä¼˜åŒ–

### 1. WALæ¨¡å¼ä¼˜åŠ¿
- æ”¯æŒå¹¶å‘è¯»å†™
- å‡å°‘é”å®šæ—¶é—´
- æé«˜æ€§èƒ½

### 2. è¿æ¥ä¼˜åŒ–
- å¢åŠ è¶…æ—¶æ—¶é—´åˆ°30ç§’
- ä¼˜åŒ–ç¼“å­˜è®¾ç½®
- å†…å­˜ä¸´æ—¶å­˜å‚¨

### 3. é”™è¯¯å¤„ç†
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- è¯¦ç»†é”™è¯¯æ—¥å¿—
- ä¼˜é›…é™çº§

---

**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**ç¨³å®šæ€§**: âœ… ä¼˜åŒ–  
**æœ€åæ›´æ–°**: 2025-07-04
